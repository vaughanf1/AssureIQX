---
phase: 01-scaffold-and-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - configs/default.yaml
  - src/utils/config.py
  - src/utils/reproducibility.py
  - src/utils/logging.py
  - Makefile
  - scripts/download.py
  - scripts/audit.py
  - scripts/split.py
  - scripts/train.py
  - scripts/eval.py
  - scripts/gradcam.py
  - scripts/infer.py
  - app/app.py
autonomous: true

must_haves:
  truths:
    - "configs/default.yaml contains all hyperparameters, paths, and seeds referenced in the architecture"
    - "make with no target prints available Makefile targets (download, audit, split, train, evaluate, gradcam, infer, report, demo, all)"
    - "src/utils/reproducibility.py sets deterministic seeds for random, numpy, torch, and torch.cuda when called"
    - "src/utils/config.py loads YAML config and supports CLI overrides"
    - "Every placeholder script loads config and sets seed before raising NotImplementedError"
  artifacts:
    - path: "configs/default.yaml"
      provides: "Central configuration with all hyperparameters"
      contains: "seed: 42"
    - path: "src/utils/config.py"
      provides: "Config loading with CLI override support"
      exports: ["load_config"]
    - path: "src/utils/reproducibility.py"
      provides: "Deterministic seed setting"
      exports: ["set_seed"]
    - path: "src/utils/logging.py"
      provides: "Logging configuration"
      exports: ["setup_logging"]
    - path: "Makefile"
      provides: "Pipeline automation targets"
      contains: ".DEFAULT_GOAL := help"
    - path: "scripts/download.py"
      provides: "Placeholder download script"
      contains: "NotImplementedError"
    - path: "scripts/train.py"
      provides: "Placeholder training script"
      contains: "NotImplementedError"
  key_links:
    - from: "scripts/train.py"
      to: "src/utils/config.py"
      via: "import load_config"
      pattern: "from src\\.utils\\.config import load_config"
    - from: "scripts/train.py"
      to: "src/utils/reproducibility.py"
      via: "import set_seed"
      pattern: "from src\\.utils\\.reproducibility import set_seed"
    - from: "configs/default.yaml"
      to: "scripts/*.py"
      via: "argparse --config flag"
      pattern: "default=\"configs/default\\.yaml\""
    - from: "Makefile"
      to: "scripts/*.py"
      via: "python scripts/X.py --config configs/default.yaml"
      pattern: "python scripts/.+\\.py --config configs/default\\.yaml"
---

<objective>
Create the configuration system (YAML config + loader), reproducibility utilities (seed setting), Makefile with all pipeline targets, and placeholder scripts for every pipeline stage.

Purpose: After this plan, `make` prints available targets, `configs/default.yaml` has all hyperparameters, and every script in `scripts/` is wired to load config and set seeds. The project is fully scaffolded and ready to receive implementation code in subsequent phases.

Output: configs/default.yaml, src/utils/{config,reproducibility,logging}.py, Makefile, scripts/{download,audit,split,train,eval,gradcam,infer}.py, app/app.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scaffold-and-infrastructure/01-RESEARCH.md
@.planning/phases/01-scaffold-and-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create configuration system and reproducibility utilities</name>
  <files>
    configs/default.yaml
    src/utils/config.py
    src/utils/reproducibility.py
    src/utils/logging.py
  </files>
  <action>
    Create configs/default.yaml using the exact content from 01-RESEARCH.md. It must contain all these sections with the exact keys:

    - data: raw_dir, splits_dir, image_size, num_workers, figshare_url
    - model: backbone (efficientnet_b0), pretrained (true), num_classes (3), dropout (0.2), class_names [Normal, Benign, Malignant]
    - training: batch_size (32), learning_rate (0.001), weight_decay (0.0001), epochs (50), early_stopping_patience (7), scheduler (cosine), class_weights (auto), loss_type (cross_entropy), split_strategy (stratified)
    - evaluation: bootstrap_iterations (1000), confidence_level (0.95), split_strategies [stratified, center]
    - gradcam: target_layer (auto), examples_per_class (3), methods [GradCAM]
    - inference: default_checkpoint (checkpoints/best_stratified.pt)
    - paths: checkpoints_dir, results_dir, docs_dir, logs_dir
    - seed: 42
    - device: auto

    Create src/utils/config.py with the load_config() function from 01-RESEARCH.md:
    - Takes config_path (str) and optional overrides (list of "key.subkey=value" strings)
    - Uses yaml.safe_load() (NEVER yaml.load())
    - Raises FileNotFoundError if config file missing
    - Supports nested key override via dot notation
    - Type coercion via yaml.safe_load on override values
    - Include type hints and docstring

    Create src/utils/reproducibility.py with the set_seed() function from 01-RESEARCH.md:
    - Sets random.seed(), np.random.seed(), torch.manual_seed(), torch.cuda.manual_seed_all()
    - Sets torch.backends.cudnn.deterministic = True
    - Sets torch.backends.cudnn.benchmark = False
    - Sets CUBLAS_WORKSPACE_CONFIG environment variable
    - Calls torch.use_deterministic_algorithms(True, warn_only=True)
    - Default seed=42
    - Include type hints and docstring

    Create src/utils/logging.py with a setup_logging() function:
    - Configures Python logging with a standard format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    - Sets level from config or defaults to INFO
    - Optionally writes to a file in the logs directory
    - Returns a logger instance
    - Include type hints and docstring
  </action>
  <verify>
    Run: `python -c "from src.utils.config import load_config; cfg = load_config('configs/default.yaml'); print(cfg['seed'], cfg['model']['backbone'])"` and confirm output is "42 efficientnet_b0".
    Run: `python -c "from src.utils.reproducibility import set_seed; set_seed(42); print('Seeds set successfully')"` and confirm no errors.
    Run: `python -c "from src.utils.logging import setup_logging; logger = setup_logging(); logger.info('test')"` and confirm no errors.
    Run: `python -c "import yaml; cfg = yaml.safe_load(open('configs/default.yaml')); assert cfg['training']['batch_size'] == 32; assert cfg['training']['learning_rate'] == 0.001; assert cfg['training']['epochs'] == 50; assert cfg['training']['early_stopping_patience'] == 7; print('Config validated')"` and confirm "Config validated".
  </verify>
  <done>
    configs/default.yaml contains all hyperparameters, paths, and seed=42. load_config() loads it and supports CLI overrides. set_seed() configures random, numpy, torch, and cuda for deterministic operation. setup_logging() provides consistent logging across scripts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Makefile and all placeholder scripts</name>
  <files>
    Makefile
    scripts/download.py
    scripts/audit.py
    scripts/split.py
    scripts/train.py
    scripts/eval.py
    scripts/gradcam.py
    scripts/infer.py
    app/app.py
  </files>
  <action>
    Create Makefile using the self-documenting pattern from 01-RESEARCH.md. CRITICAL: Makefile recipe lines MUST use literal tab characters (not spaces). The Makefile must have:

    - .DEFAULT_GOAL := help
    - help target: grep+awk pattern that extracts "## comment" descriptions
    - download target: `python scripts/download.py --config configs/default.yaml`
    - audit target: `python scripts/audit.py --config configs/default.yaml`
    - split target: `python scripts/split.py --config configs/default.yaml`
    - train target: `python scripts/train.py --config configs/default.yaml`
    - evaluate target: `python scripts/eval.py --config configs/default.yaml`
    - gradcam target: `python scripts/gradcam.py --config configs/default.yaml`
    - infer target: `python scripts/infer.py --config configs/default.yaml`
    - report target: `@echo "Report generation is manual -- see docs/"`
    - demo target: `streamlit run app/app.py`
    - all target: chains download audit split train evaluate gradcam report
    - All targets marked .PHONY
    - Each target has a `## Description` comment for the help output

    Create 7 placeholder scripts (download.py, audit.py, split.py, train.py, eval.py, gradcam.py, infer.py) using the standardized template from 01-RESEARCH.md. Each script must:
    1. Have a shebang line: `#!/usr/bin/env python3`
    2. Have a module docstring describing what it does and its usage
    3. Import argparse, sys, Path
    4. Set PROJECT_ROOT and insert into sys.path
    5. Import load_config from src.utils.config
    6. Import set_seed from src.utils.reproducibility
    7. Have a main() function with argparse (--config and --override flags)
    8. Load config and set seed in main()
    9. Raise NotImplementedError with a message indicating which phase implements it
    10. Have `if __name__ == "__main__": main()` guard

    Script-specific details:
    - download.py: "Download BTXRD dataset from figshare" -- Phase 2
    - audit.py: "Profile dataset quality and generate audit report" -- Phase 2
    - split.py: "Generate train/val/test split manifests" -- Phase 3
    - train.py: "Train EfficientNet-B0 classifier on BTXRD dataset" -- Phase 4
    - eval.py: "Evaluate trained model on both split strategies" -- Phase 5
    - gradcam.py: "Generate Grad-CAM heatmaps for selected examples" -- Phase 6
    - infer.py: "Run single-image or batch inference with Grad-CAM overlay" -- Phase 6
      - infer.py additionally needs --image and --input-dir argparse arguments (optional, in addition to --config)

    Create app/app.py as a minimal Streamlit placeholder:
    ```python
    """AssureXRay Streamlit Demo -- Phase 8 implementation."""
    # TODO: Implement in Phase 8
    ```

    IMPORTANT: After writing the Makefile, verify tab characters are correct by running `cat -A Makefile | head -20` -- recipe lines must show ^I (tab), not spaces.
  </action>
  <verify>
    Run: `make` and confirm it prints formatted help with all targets listed (download, audit, split, train, evaluate, gradcam, infer, report, demo, all).
    Run: `make -n download` (dry run) and confirm it would execute `python scripts/download.py --config configs/default.yaml`.
    Run: `python scripts/train.py --config configs/default.yaml 2>&1 || true` and confirm it raises NotImplementedError with Phase 4 reference.
    Run: `python scripts/infer.py --help` and confirm --image and --input-dir arguments are shown.
    Run: `for f in scripts/*.py; do python -c "import ast; ast.parse(open('$f').read()); print(f'$f: valid')" ; done` to confirm all scripts parse without syntax errors.
  </verify>
  <done>
    Makefile prints formatted help with 10+ targets when run with no arguments. All 7 placeholder scripts load config, set seed, and raise NotImplementedError pointing to their implementation phase. app/app.py exists as a Streamlit placeholder. `make -n all` shows the full pipeline chain.
  </done>
</task>

</tasks>

<verification>
1. `make` prints formatted help listing: download, audit, split, train, evaluate, gradcam, infer, report, demo, all
2. `python -c "from src.utils.config import load_config; c = load_config('configs/default.yaml'); assert c['seed'] == 42"` passes
3. `python -c "from src.utils.reproducibility import set_seed; set_seed(42)"` completes without error
4. `python scripts/train.py --config configs/default.yaml 2>&1 | grep NotImplementedError` matches
5. `grep -l "load_config" scripts/*.py | wc -l` returns 7 (all scripts import config)
6. `grep -l "set_seed" scripts/*.py | wc -l` returns 7 (all scripts set seed)
7. `cat -A Makefile | grep "^.I"` confirms tab characters in recipe lines
</verification>

<success_criteria>
- configs/default.yaml has all hyperparameters matching the architecture spec (lr, batch_size, epochs, patience, backbone, loss_type, split ratios, seed)
- `make` with no target prints formatted help with all pipeline targets
- src/utils/reproducibility.py sets deterministic seeds for random, numpy, torch, and cuda
- src/utils/config.py loads YAML config with CLI override support
- All 7 placeholder scripts follow the standardized template (shebang, docstring, argparse, config load, seed set, NotImplementedError)
- Makefile uses actual tab characters for recipe lines
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-and-infrastructure/01-02-SUMMARY.md`
</output>
