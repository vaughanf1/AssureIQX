---
phase: 08-streamlit-demo
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/app.py
  - requirements.txt
  - .streamlit/config.toml
autonomous: false

must_haves:
  truths:
    - "Running `make demo` launches a local Streamlit web app in the browser"
    - "User can upload a radiograph image and see a 3-class prediction with confidence bars"
    - "User can see a Grad-CAM heatmap overlay alongside the uploaded image"
    - "A prominent NOT FOR CLINICAL USE disclaimer is visible before and after image upload"
  artifacts:
    - path: "app/app.py"
      provides: "Complete Streamlit demo application"
      min_lines: 80
      contains: "st.file_uploader"
    - path: "requirements.txt"
      provides: "Streamlit dependency declaration"
      contains: "streamlit>=1.42.0"
    - path: ".streamlit/config.toml"
      provides: "Streamlit configuration (telemetry off)"
      contains: "gatherUsageStats"
  key_links:
    - from: "app/app.py"
      to: "src/models/factory.py"
      via: "import load_checkpoint, create_model, get_device"
      pattern: "from src\\.models\\.factory import"
    - from: "app/app.py"
      to: "src/explainability/gradcam.py"
      via: "import generate_gradcam, create_overlay, denormalize_tensor"
      pattern: "from src\\.explainability\\.gradcam import"
    - from: "app/app.py"
      to: "src/data/transforms.py"
      via: "import get_test_transforms"
      pattern: "from src\\.data\\.transforms import"
    - from: "app/app.py"
      to: "checkpoints/best_stratified.pt"
      via: "DEFAULT_CHECKPOINT path constant"
      pattern: "best_stratified\\.pt"
---

<objective>
Build the complete Streamlit demo application that allows a non-technical user to upload a bone radiograph, view a 3-class prediction with confidence bar chart and Grad-CAM heatmap overlay, with a persistent clinical disclaimer.

Purpose: This is the final phase (Phase 8) -- the demo makes the entire pipeline accessible to non-technical users via a browser, completing the project.
Output: A working `app/app.py` that `make demo` launches, plus streamlit added to requirements.txt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-streamlit-demo/08-RESEARCH.md

# Source modules the app imports from (read these to understand exact APIs)
@src/models/factory.py
@src/explainability/gradcam.py
@src/data/transforms.py
@scripts/infer.py
@app/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Streamlit app, add dependency, create config</name>
  <files>
    app/app.py
    requirements.txt
    .streamlit/config.toml
  </files>
  <action>
    **1. Add streamlit to requirements.txt:**
    Append `streamlit>=1.42.0` to the end of requirements.txt under a new `# Demo` section comment. Then run `pip install streamlit>=1.42.0` to install it.

    **2. Create `.streamlit/config.toml`:**
    Create the directory `.streamlit/` and a minimal config.toml with:
    ```toml
    [browser]
    gatherUsageStats = false

    [server]
    headless = true
    ```

    **3. Rewrite `app/app.py`:**
    Replace the existing placeholder stub with the full Streamlit application. Follow the complete code example from 08-RESEARCH.md closely, with these specifics:

    - **sys.path setup**: Add PROJECT_ROOT to sys.path at the top (same pattern as scripts/infer.py) so `src/` imports work regardless of working directory.
    - **Imports**: Import from `src.models.factory` (create_model, load_checkpoint, get_device), `src.explainability.gradcam` (generate_gradcam, create_overlay, denormalize_tensor), `src.data.transforms` (get_test_transforms). Also import streamlit, torch, torch.nn.functional, PIL.Image, numpy, pandas.
    - **Constants**: `DEFAULT_CHECKPOINT = PROJECT_ROOT / "checkpoints" / "best_stratified.pt"` and `IMAGE_SIZE = 224`.
    - **`@st.cache_resource` for model loading**: A `load_model(checkpoint_path: str)` function that calls get_device("auto"), load_checkpoint to CPU, create_model, load_state_dict, move to device, set eval mode, and returns `(model, class_names, device)`.
    - **`run_inference()` function**: Takes model, input_tensor, class_names, device. Runs forward pass inside `torch.no_grad()` for logits and softmax. Then calls `generate_gradcam()` OUTSIDE no_grad (it needs gradients). Uses `denormalize_tensor()` and `create_overlay()` to produce the overlay. Returns a dict with pred_class, pred_idx, confidence array, class_names, overlay (uint8 numpy), and original_rgb (uint8 numpy).
    - **`main()` function**:
      - `st.set_page_config(page_title="AssureXRay", page_icon=":material/radiology:", layout="wide")` -- must be first Streamlit call.
      - `st.title("AssureXRay -- Bone Tumor Classification")`
      - `st.warning("**NOT FOR CLINICAL USE -- Research Prototype Only.** This tool is for demonstration purposes only and has not been validated for clinical decision-making.")` -- unconditional, always visible.
      - Call `load_model(str(DEFAULT_CHECKPOINT))`.
      - `st.file_uploader("Upload a bone radiograph", type=["jpg", "jpeg", "png", "bmp", "tiff"])`.
      - If file uploaded: open with PIL, convert to RGB, apply `get_test_transforms(IMAGE_SIZE)`, unsqueeze to batch. Wrap inference in `st.spinner("Analyzing image...")`.
      - Display results in two columns: left = uploaded original image, right = Grad-CAM overlay. Use `st.image(..., use_container_width=True)`.
      - Show prediction class as `st.subheader(f"Prediction: {result['pred_class']}")`.
      - Show confidence bar chart using `pd.DataFrame` with Class and Confidence columns, rendered via `st.bar_chart(scores_df, x="Class", y="Confidence", horizontal=True)`.
    - **`if __name__ == "__main__": main()`** at the bottom.

    **Avoid:**
    - Do NOT use `st.cache` (deprecated) -- use `st.cache_resource`.
    - Do NOT wrap `generate_gradcam()` in `torch.no_grad()` -- Grad-CAM needs gradients.
    - Do NOT use `use_column_width` (deprecated) -- use `use_container_width=True`.
    - Do NOT import `cv2` -- use PIL and numpy for image handling. `st.image` accepts numpy arrays directly.
    - Do NOT add plotly or matplotlib -- `st.bar_chart` handles the confidence visualization natively.
  </action>
  <verify>
    1. `python -c "import streamlit; print(streamlit.__version__)"` succeeds and prints >= 1.42.0
    2. `python -c "import app.app"` succeeds (no import errors -- note: this only tests import resolution, not Streamlit runtime)
    3. `grep -q 'streamlit>=1.42.0' requirements.txt` returns 0
    4. `test -f .streamlit/config.toml` returns 0
    5. `grep -c 'st.file_uploader\|st.warning\|st.bar_chart\|cache_resource\|generate_gradcam' app/app.py` returns 5 (all key patterns present)
  </verify>
  <done>
    app/app.py is a complete Streamlit application (80+ lines) that imports from src/ modules, uses @st.cache_resource for model loading, displays a persistent disclaimer, accepts image upload, runs inference with Grad-CAM, and shows results with confidence bars. streamlit>=1.42.0 is in requirements.txt. .streamlit/config.toml exists with telemetry disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Smoke test the Streamlit app launches without errors</name>
  <files>app/app.py</files>
  <action>
    Run a headless smoke test to verify the Streamlit app starts without import errors or configuration issues.

    **Step 1**: Run Streamlit in headless mode briefly to check it starts:
    ```bash
    timeout 15 streamlit run app/app.py --server.headless true --server.port 8502 2>&1 || true
    ```
    The app should print "You can now view your Streamlit app in your browser" before the timeout kills it. Check the output does NOT contain `ModuleNotFoundError`, `ImportError`, or `FileNotFoundError`.

    **Step 2**: Verify the app module can be imported without Streamlit runtime:
    ```bash
    cd /path/to/project && python -c "
    import sys; sys.path.insert(0, '.')
    # Check all imports resolve
    from src.models.factory import create_model, load_checkpoint, get_device
    from src.explainability.gradcam import generate_gradcam, create_overlay, denormalize_tensor
    from src.data.transforms import get_test_transforms
    print('All imports OK')
    "
    ```

    If any errors occur in Step 1, fix the import paths or configuration in app/app.py.
  </action>
  <verify>
    1. The headless Streamlit launch output contains "You can now view your Streamlit app" or "Local URL"
    2. No `ModuleNotFoundError` or `ImportError` in the output
    3. The Python import check prints "All imports OK"
  </verify>
  <done>
    The Streamlit app launches without errors in headless mode. All src/ module imports resolve correctly. The app is ready for human visual verification.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Streamlit demo application for bone tumor classification. The app accepts image upload, runs EfficientNet-B0 inference with Grad-CAM visualization, displays prediction with confidence bar chart, and shows a persistent clinical disclaimer.
  </what-built>
  <how-to-verify>
    1. Run `make demo` (or `streamlit run app/app.py`) -- the browser should open to the app
    2. Confirm the "NOT FOR CLINICAL USE -- Research Prototype Only" warning is visible at the top of the page BEFORE uploading any image
    3. Upload a test radiograph image (try one from `data_raw/images/` such as `IMG000001.jpeg`)
    4. Verify the "Analyzing image..." spinner appears briefly
    5. Confirm two columns appear: left showing the uploaded image, right showing the Grad-CAM heatmap overlay
    6. Confirm a prediction heading shows the predicted class (Normal, Benign, or Malignant)
    7. Confirm a horizontal bar chart shows confidence scores for all 3 classes
    8. Confirm the disclaimer is STILL visible after results are displayed
    9. Try uploading a different image to verify the app handles multiple uploads
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the layout, predictions, or visual presentation</resume-signal>
</task>

</tasks>

<verification>
Phase-level verification:
1. `make demo` launches the Streamlit app without errors
2. Image upload produces a prediction, confidence bars, and Grad-CAM overlay
3. The NOT FOR CLINICAL USE disclaimer is visible in all app states
4. The output matches the behavior of `scripts/infer.py` (same model, same preprocessing, same Grad-CAM)
</verification>

<success_criteria>
1. Running `make demo` (or `streamlit run app/app.py`) launches a local web app that allows image upload
2. Uploaded images produce a class prediction with confidence bar chart and Grad-CAM heatmap overlay, matching the output of the CLI inference script
3. A prominent "NOT FOR CLINICAL USE -- Research Prototype Only" disclaimer is visible on every page of the app
</success_criteria>

<output>
After completion, create `.planning/phases/08-streamlit-demo/08-01-SUMMARY.md`
</output>
